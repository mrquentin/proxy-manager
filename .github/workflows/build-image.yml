name: Build VPS Image

on:
  push:
    tags: ['v*']

env:
  GO_VERSION: '1.23'

jobs:
  build-controlplane:
    name: Build Control Plane Binary
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Build control plane binary (amd64 + arm64)
        working-directory: controlplane
        run: |
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 \
            go build -ldflags="-s -w -X main.version=${{ github.ref_name }}" -o ../image/files/controlplane-amd64 ./cmd/controlplane
          CGO_ENABLED=0 GOOS=linux GOARCH=arm64 \
            go build -ldflags="-s -w -X main.version=${{ github.ref_name }}" -o ../image/files/controlplane-arm64 ./cmd/controlplane

      - uses: actions/upload-artifact@v4
        with:
          name: controlplane-binary
          path: image/files/controlplane-*
          retention-days: 1

  build-image:
    name: Build Image (${{ matrix.provider }})
    needs: build-controlplane
    runs-on: ubuntu-latest
    strategy:
      matrix:
        provider: [hcloud]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: controlplane-binary
          path: image/files/

      - name: Make binary executable
        run: chmod +x image/files/controlplane

      - name: Setup Packer
        uses: hashicorp/setup-packer@main
        with:
          version: latest

      - name: Packer Init
        working-directory: image
        run: packer init .

      - name: Packer Validate
        working-directory: image
        run: packer validate -var-file="providers/${{ matrix.provider }}.pkrvars.hcl" .

      - name: Packer Build
        working-directory: image
        env:
          HCLOUD_TOKEN: ${{ secrets.HCLOUD_TOKEN }}
          PKR_VAR_build_version: ${{ github.ref_name }}
        run: packer build -var-file="providers/${{ matrix.provider }}.pkrvars.hcl" .

  scan:
    name: Trivy Security Scan
    needs: build-image
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Scan with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: fs
          scan-ref: image/
          severity: HIGH,CRITICAL
          exit-code: 1
